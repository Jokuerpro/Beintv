<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xtream Pro - Ù…Ø´ØºÙ„ IPTV Ù…ØªÙƒØ§Ù…Ù„</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root {
      --primary-color: #00b894;
      --secondary-color: #00695c;
      --dark-color: #101820;
      --light-color: #f5f5f5;
      --error-color: #ff5252;
      --warning-color: #ffc107;
      --success-color: #4caf50;
      --info-color: #2196f3;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', 'Tahoma', Geneva, Verdana, sans-serif;
      background: var(--dark-color);
      color: white;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Header Styles */
    .header {
      background: var(--primary-color);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .logo {
      font-size: 22px;
      font-weight: bold;
      color: white;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .input-area {
      display: flex;
      gap: 10px;
      flex-grow: 1;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    
    .input-area input {
      padding: 10px 15px;
      border-radius: 6px;
      border: none;
      min-width: 300px;
      max-width: 100%;
      font-size: 16px;
      background: rgba(255,255,255,0.9);
    }
    
    .btn {
      padding: 10px 20px;
      background-color: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    .btn-primary {
      background-color: var(--primary-color);
    }
    
    .btn-danger {
      background-color: var(--error-color);
    }
    
    .btn-warning {
      background-color: var(--warning-color);
      color: #000;
    }
    
    .btn-success {
      background-color: var(--success-color);
    }
    
    .btn-info {
      background-color: var(--info-color);
    }
    
    /* Main Content */
    .main-content {
      flex: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      width: 100%;
    }
    
    /* Controls Section */
    .controls-section {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .controls-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    
    select, input[type="text"], input[type="password"] {
      padding: 12px 15px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      width: 100%;
      background: rgba(255,255,255,0.9);
    }
    
    select:focus, input:focus {
      outline: 2px solid var(--primary-color);
    }
    
    /* Video Player */
    .player-container {
      position: relative;
      margin-bottom: 20px;
    }
    
    video {
      width: 100%;
      max-height: 70vh;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      background: #000;
      display: block;
    }
    
    /* EPG Section */
    .epg-section {
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      display: none;
    }
    
    .epg-container {
      display: flex;
      overflow-x: auto;
      gap: 10px;
      padding: 10px 0;
    }
    
    .epg-program {
      min-width: 200px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 10px;
      border-left: 3px solid var(--primary-color);
    }
    
    .epg-program.live {
      border-left-color: var(--error-color);
    }
    
    .epg-time {
      font-size: 12px;
      color: #ccc;
    }
    
    .epg-title {
      font-weight: bold;
      margin: 5px 0;
    }
    
    .epg-description {
      font-size: 14px;
      color: #ddd;
    }
    
    /* Multiview */
    .multiview-container {
      display: none;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .multiview-screen {
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    
    .multiview-screen video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .multiview-controls {
      position: absolute;
      bottom: 5px;
      left: 5px;
      right: 5px;
      display: flex;
      justify-content: center;
      gap: 5px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .multiview-screen:hover .multiview-controls {
      opacity: 1;
    }
    
    /* Favorites Menu */
    .favorites-menu {
      position: fixed;
      top: 60px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      border-radius: 8px;
      padding: 10px;
      max-width: 300px;
      max-height: 400px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
    }
    
    .favorite-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .favorite-item span {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Notifications */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      max-width: 300px;
    }
    
    .notification.error {
      border-left: 4px solid var(--error-color);
    }
    
    .notification.success {
      border-left: 4px solid var(--success-color);
    }
    
    .notification.warning {
      border-left: 4px solid var(--warning-color);
    }
    
    .notification.info {
      border-left: 4px solid var(--info-color);
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    
    /* Loading Indicator */
    .loading {
      display: none;
      margin: 20px 0;
      color: var(--primary-color);
      text-align: center;
    }
    
    .loading i {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Channel Info */
    .channel-info {
      margin: 15px 0;
      padding: 10px;
      background: rgba(0, 184, 148, 0.1);
      border-radius: 5px;
      display: none;
      align-items: center;
      gap: 15px;
    }
    
    .channel-logo {
      height: 50px;
      width: 50px;
      object-fit: contain;
      border-radius: 50%;
      background: rgba(0,0,0,0.3);
    }
    
    /* Parental Control */
    .parental-control {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 2000;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 20px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .controls-row {
        grid-template-columns: 1fr;
      }
      
      .header {
        flex-direction: column;
        text-align: center;
      }
      
      .input-area {
        justify-content: center;
      }
      
      .multiview-container {
        grid-template-columns: 1fr;
      }
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      margin-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    
    .tab.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
      font-weight: bold;
    }
    
    /* Rating */
    .rating-stars {
      display: flex;
      gap: 5px;
      margin-top: 10px;
    }
    
    .rating-star {
      color: #ccc;
      cursor: pointer;
      font-size: 20px;
      transition: color 0.2s;
    }
    
    .rating-star.active {
      color: var(--warning-color);
    }
    
    /* Recording Indicator */
    .recording-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--error-color);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Parental Control Overlay -->
  <div class="parental-control" id="parentalControl">
    <h2>Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø£Ø¨ÙˆÙŠØ©</h2>
    <p>Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ù†Ø§Ø© Ù…Ø­Ù…ÙŠØ© Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©:</p>
    <input type="password" id="parentalPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button class="btn btn-primary" onclick="checkParentalPassword()">ØªØ£ÙƒÙŠØ¯</button>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="logo">
      <i class="fas fa-tv"></i>
      <span>Xtream Pro</span>
    </div>
    
    <div class="input-area">
      <input type="text" id="m3uUrl" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ M3U">
      <button class="btn btn-primary" onclick="loadM3U()">
        <i class="fas fa-cloud-download-alt"></i>
        ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
      </button>
      <button class="btn btn-success" onclick="saveFavorite()">
        <i class="fas fa-heart"></i>
        Ø­ÙØ¸ Ø§Ù„Ù…ÙØ¶Ù„Ø©
      </button>
      <button class="btn btn-info" onclick="toggleFavoritesMenu()">
        <i class="fas fa-star"></i>
        Ø§Ù„Ù…ÙØ¶Ù„Ø©
      </button>
    </div>
    
    <div class="favorites-menu" id="favoritesMenu"></div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Loading Indicator -->
    <div class="loading" id="loading">
      <i class="fas fa-spinner fa-2x"></i>
      <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</p>
    </div>
    
    <!-- Error Message -->
    <div class="error-message" id="errorMessage"></div>
    
    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="player" onclick="switchTab('player')">Ø§Ù„Ù…Ø´ØºÙ„</div>
      <div class="tab" data-tab="multiview" onclick="switchTab('multiview')">Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©</div>
      <div class="tab" data-tab="epg" onclick="switchTab('epg')">Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬</div>
    </div>
    
    <!-- Player Tab -->
    <div class="tab-content" id="playerTab">
      <!-- Controls -->
      <div class="controls-section">
        <div class="controls-row">
          <select id="categorySelect" onchange="showChannels()">
            <option value="">Ø§Ø®ØªØ± ÙØ¦Ø©</option>
          </select>

          <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ù†Ø§Ø©" oninput="searchChannels()">

          <select id="channelSelect" onchange="playChannel()">
            <option value="">Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø©</option>
          </select>
        </div>
        
        <div class="controls-row" id="advancedControls" style="display: none;">
          <div class="quality-selector">
            <span>Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø«:</span>
            <select id="qualitySelect" onchange="changeQuality()"></select>
          </div>
          
          <div class="subtitle-controls">
            <span>Ø§Ù„ØªØ±Ø¬Ù…Ø©:</span>
            <select id="subtitleSelect" onchange="loadSubtitle()">
              <option value="">Ø¨Ø¯ÙˆÙ† ØªØ±Ø¬Ù…Ø©</option>
              <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
              <option value="en">Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
            </select>
          </div>
          
          <div class="audio-controls">
            <span>Ø§Ù„ØµÙˆØª:</span>
            <select id="audioTrackSelect" onchange="changeAudioTrack()">
              <option value="original">Ø§Ù„Ø£ØµÙ„ÙŠ</option>
              <option value="dubbed">Ù…Ø¯Ø¨Ù„Ø¬</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Channel Info -->
      <div class="channel-info" id="channelInfo">
        <img src="" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù‚Ù†Ø§Ø©" class="channel-logo" id="channelLogo">
        <div>
          <h3 id="channelName"></h3>
          <div class="rating-stars" id="ratingStars">
            <i class="fas fa-star rating-star" data-rating="1"></i>
            <i class="fas fa-star rating-star" data-rating="2"></i>
            <i class="fas fa-star rating-star" data-rating="3"></i>
            <i class="fas fa-star rating-star" data-rating="4"></i>
            <i class="fas fa-star rating-star" data-rating="5"></i>
          </div>
        </div>
      </div>
      
      <!-- Player -->
      <div class="player-container">
        <div class="recording-indicator" id="recordingIndicator">
          <i class="fas fa-circle"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...
        </div>
        <video id="player" controls autoplay></video>
      </div>
      
      <!-- Player Controls -->
      <div class="player-controls">
        <button class="btn btn-primary" onclick="toggleFullscreen()">
          <i class="fas fa-expand"></i> Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
        </button>
        <button class="btn btn-success" id="recordBtn" onclick="toggleRecording()">
          <i class="fas fa-circle"></i> ØªØ³Ø¬ÙŠÙ„
        </button>
        <button class="btn btn-warning" onclick="enableBatterySaver()">
          <i class="fas fa-battery-quarter"></i> ØªÙˆÙÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
        </button>
        <button class="btn btn-danger" onclick="lockParentalControl()">
          <i class="fas fa-lock"></i> Ù‚ÙÙ„ Ø£Ø¨ÙˆÙŠ
        </button>
      </div>
    </div>
    
    <!-- Multiview Tab -->
    <div class="tab-content" id="multiviewTab" style="display: none;">
      <div class="multiview-container" id="multiviewContainer">
        <div class="multiview-screen" data-channel="1">
          <video></video>
          <div class="multiview-controls">
            <select class="multiview-channel-select" onchange="changeMultiviewChannel(1, this.value)"></select>
            <button class="btn btn-primary btn-sm" onclick="focusMultiviewScreen(1)">
              <i class="fas fa-expand"></i>
            </button>
          </div>
        </div>
        <div class="multiview-screen" data-channel="2">
          <video></video>
          <div class="multiview-controls">
            <select class="multiview-channel-select" onchange="changeMultiviewChannel(2, this.value)"></select>
            <button class="btn btn-primary btn-sm" onclick="focusMultiviewScreen(2)">
              <i class="fas fa-expand"></i>
            </button>
          </div>
        </div>
        <div class="multiview-screen" data-channel="3">
          <video></video>
          <div class="multiview-controls">
            <select class="multiview-channel-select" onchange="changeMultiviewChannel(3, this.value)"></select>
            <button class="btn btn-primary btn-sm" onclick="focusMultiviewScreen(3)">
              <i class="fas fa-expand"></i>
            </button>
          </div>
        </div>
        <div class="multiview-screen" data-channel="4">
          <video></video>
          <div class="multiview-controls">
            <select class="multiview-channel-select" onchange="changeMultiviewChannel(4, this.value)"></select>
            <button class="btn btn-primary btn-sm" onclick="focusMultiviewScreen(4)">
              <i class="fas fa-expand"></i>
            </button>
          </div>
        </div>
      </div>
      
      <div class="multiview-controls">
        <button class="btn btn-primary" onclick="startAllMultiview()">
          <i class="fas fa-play"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙ„
        </button>
        <button class="btn btn-danger" onclick="stopAllMultiview()">
          <i class="fas fa-stop"></i> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒÙ„
        </button>
      </div>
    </div>
    
    <!-- EPG Tab -->
    <div class="tab-content" id="epgTab" style="display: none;">
      <div class="epg-section" id="epgSection">
        <h3>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h3>
        <div class="epg-container" id="epgContainer"></div>
      </div>
      
      <div class="epg-controls">
        <button class="btn btn-primary" onclick="loadCurrentEPG()">
          <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ«
        </button>
        <button class="btn btn-success" onclick="addCurrentToCalendar()">
          <i class="fas fa-calendar-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
        </button>
      </div>
    </div>
  </main>

  <script>
    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    let categories = {};
    let channels = [];
    let currentCategory = [];
    let channelQuality = {};
    let currentChannel = null;
    let currentHls = null;
    let currentRecorder = null;
    let multiviewPlayers = {};
    let parentalControlEnabled = localStorage.getItem('parentalControlEnabled') === 'true';
    let parentalPassword = localStorage.getItem('parentalPassword') || '1234';
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    let channelRatings = JSON.parse(localStorage.getItem('channelRatings') || '{}');
    let viewingStats = JSON.parse(localStorage.getItem('viewingStats') || []);
    let currentTab = 'player';

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.onload = () => {
      const lastUrl = localStorage.getItem('lastM3U');
      if (lastUrl) {
        document.getElementById('m3uUrl').value = lastUrl;
      }
      
      updateFavoritesMenu();
      setupRatingStars();
      
      // ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø§Ø¨Ø· Ù…Ø®Ø²Ù†
      if (lastUrl && confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± Ù‚Ø§Ø¦Ù…Ø© ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ØŸ')) {
        loadM3U();
      }
      
      // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
      initMultiview();
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø£Ø¨ÙˆÙŠØ©
      if (parentalControlEnabled) {
        document.getElementById('parentalControl').style.display = 'flex';
      }
    };

    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    function switchTab(tabName) {
      currentTab = tabName;
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });
      
      document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = content.id === tabName + 'Tab' ? 'block' : 'none';
      });
      
      if (tabName === 'multiview') {
        document.getElementById('multiviewContainer').style.display = 'grid';
      } else {
        document.getElementById('multiviewContainer').style.display = 'none';
      }
      
      if (tabName === 'epg' && currentChannel) {
        loadEPG(currentChannel.name);
        document.getElementById('epgSection').style.display = 'block';
      }
    }

    // Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ ØªØ­Ù…ÙŠÙ„
    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 
                        type === 'success' ? 'fa-check-circle' : 
                        type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
      `;
      
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 5000);
    }

    // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© M3U
    function loadM3U() {
      const url = document.getElementById('m3uUrl').value.trim();
      if (!url) {
        showNotification("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ M3U.", 'error');
        return;
      }

      showLoading(true);
      document.getElementById('errorMessage').style.display = 'none';
      localStorage.setItem('lastM3U', url);

      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${response.status}`);
          return response.text();
        })
        .then(data => parseM3U(data))
        .catch(err => {
          showLoading(false);
          showNotification("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: " + err.message, 'error');
          console.error(err);
        });
    }

    // ØªØ­Ù„ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© M3U
    function parseM3U(data) {
      categories = {};
      channels = [];
      channelQuality = {};
      currentChannel = null;

      const lines = data.split('\n');
      let currentChannelInfo = {};

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line.startsWith('#EXTINF')) {
          const nameMatch = line.match(/,(.*)/);
          const groupMatch = line.match(/group-title="(.*?)"/);
          const tvgNameMatch = line.match(/tvg-name="(.*?)"/);
          const tvgLogoMatch = line.match(/tvg-logo="(.*?)"/);
          const parentalMatch = line.match(/parental-control="(.*?)"/);
          
          currentChannelInfo = {
            name: nameMatch ? nameMatch[1].trim() : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
            group: groupMatch ? groupMatch[1].trim() : "ØºÙŠØ± Ù…ØµÙ†ÙØ©",
            tvgName: tvgNameMatch ? tvgNameMatch[1].trim() : '',
            tvgLogo: tvgLogoMatch ? tvgLogoMatch[1].trim() : '',
            parentalLocked: parentalMatch ? parentalMatch[1] === 'yes' : false
          };
        } else if (line.startsWith('http')) {
          currentChannelInfo.url = line.trim();

          // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¬ÙˆØ¯Ø© Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©
          const qualityMatch = currentChannelInfo.name.match(/(HD|SD|FHD|4K|1080p|720p|480p)/i);
          let quality = qualityMatch ? qualityMatch[0].toUpperCase() : 'SD';
          
          // ØªØ­Ø³ÙŠÙ† ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø©
          if (quality === '1080P') quality = 'FHD';
          if (quality === '720P') quality = 'HD';
          if (quality === '480P') quality = 'SD';

          const channelName = currentChannelInfo.tvgName || currentChannelInfo.name;

          if (!channelQuality[channelName]) {
            channelQuality[channelName] = [];
          }
          
          channelQuality[channelName].push({
            url: currentChannelInfo.url,
            quality: quality,
            fullInfo: {...currentChannelInfo}
          });

          if (!categories[currentChannelInfo.group]) {
            categories[currentChannelInfo.group] = [];
          }
          
          // ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
          if (!categories[currentChannelInfo.group].some(ch => ch.name === channelName)) {
            categories[currentChannelInfo.group].push({
              name: channelName,
              group: currentChannelInfo.group,
              tvgName: currentChannelInfo.tvgName,
              tvgLogo: currentChannelInfo.tvgLogo,
              parentalLocked: currentChannelInfo.parentalLocked
            });
          }
          
          channels.push({...currentChannelInfo});
        }
      }

      fillCategories();
      showLoading(false);
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„ØªÙŠ ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§
      const totalChannels = Object.values(categories).reduce((sum, cat) => sum + cat.length, 0);
      showNotification(`ØªÙ… ØªØ­Ù…ÙŠÙ„ ${totalChannels} Ù‚Ù†Ø§Ø© ÙÙŠ ${Object.keys(categories).length} ÙØ¦Ø©`, 'success');
    }

    // Ù…Ù„Ø¡ Ø§Ù„ÙØ¦Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
    function fillCategories() {
      const select = document.getElementById('categorySelect');
      select.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙØ¦Ø©</option>';

      // ØªØ±ØªÙŠØ¨ Ø§Ù„ÙØ¦Ø§Øª Ø£Ø¨Ø¬Ø¯ÙŠÙ‹Ø§
      const sortedCategories = Object.keys(categories).sort();
      
      sortedCategories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = `${cat} (${categories[cat].length})`;
        select.appendChild(option);
      });

      document.getElementById('channelSelect').innerHTML = '<option value="">Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø©</option>';
      document.getElementById('advancedControls').style.display = 'none';
      document.getElementById('channelInfo').style.display = 'none';
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ù†ÙˆØ§Øª ÙÙŠ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    function showChannels() {
      const cat = document.getElementById('categorySelect').value;
      const select = document.getElementById('channelSelect');
      select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø©</option>';

      currentCategory = cat && categories[cat] ? categories[cat] : [];

      // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø£Ø¨Ø¬Ø¯ÙŠÙ‹Ø§
      currentCategory.sort((a, b) => a.name.localeCompare(b.name))
        .forEach(ch => {
          const option = document.createElement('option');
          option.value = ch.name;
          option.textContent = ch.name;
          if (ch.tvgLogo) {
            option.setAttribute('data-logo', ch.tvgLogo);
          }
          if (ch.parentalLocked) {
            option.setAttribute('data-parental', 'true');
          }
          select.appendChild(option);
        });

      document.getElementById('searchInput').value = "";
      document.getElementById('advancedControls').style.display = 'none';
      document.getElementById('channelInfo').style.display = 'none';
    }

    // Ø¨Ø­Ø« Ø§Ù„Ù‚Ù†ÙˆØ§Øª
    function searchChannels() {
      const keyword = document.getElementById('searchInput').value.toLowerCase();
      const select = document.getElementById('channelSelect');
      select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø©</option>';

      if (!keyword) {
        showChannels();
        return;
      }

      // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù†ÙˆØ§Øª ÙˆÙ„ÙŠØ³ ÙÙ‚Ø· Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      channels
        .filter(ch => ch.name.toLowerCase().includes(keyword) || 
                      (ch.tvgName && ch.tvgName.toLowerCase().includes(keyword)))
        .forEach(ch => {
          // ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
          if (!Array.from(select.options).some(opt => opt.value === ch.name)) {
            const option = document.createElement('option');
            option.value = ch.name;
            option.textContent = ch.name;
            if (ch.tvgLogo) {
              option.setAttribute('data-logo', ch.tvgLogo);
            }
            if (ch.parentalLocked) {
              option.setAttribute('data-parental', 'true');
            }
            select.appendChild(option);
          }
        });
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    function playChannel() {
      const channelName = document.getElementById('channelSelect').value;
      const video = document.getElementById('player');
      const advancedControls = document.getElementById('advancedControls');
      const channelInfoEl = document.getElementById('channelInfo');

      if (!channelName) return;

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø£Ø¨ÙˆÙŠØ©
      const selectedOption = document.querySelector(`#channelSelect option[value="${channelName}"]`);
      const isParentalLocked = selectedOption ? selectedOption.getAttribute('data-parental') === 'true' : false;
      
      if (isParentalLocked && parentalControlEnabled) {
        document.getElementById('parentalControl').style.display = 'flex';
        currentChannel = channelQuality[channelName][0].fullInfo;
        return;
      }

      // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø¨Ø« Ø­Ø§Ù„ÙŠØ©
      if (currentHls) {
        currentHls.destroy();
        currentHls = null;
      }

      const channelLogo = selectedOption ? selectedOption.getAttribute('data-logo') : '';

      // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù‚Ù†Ø§Ø©
      if (channelLogo) {
        document.getElementById('channelLogo').src = channelLogo;
        document.getElementById('channelName').textContent = channelName;
        channelInfoEl.style.display = 'flex';
      } else {
        document.getElementById('channelName').textContent = channelName;
        channelInfoEl.style.display = 'block';
      }

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
      updateRatingStars(channelName);

      const availableQualities = channelQuality[channelName];
      if (!availableQualities || availableQualities.length === 0) {
        showNotification("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ù†Ø§Ø©", 'error');
        return;
      }

      // Ø­ÙØ¸ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      currentChannel = availableQualities[0].fullInfo;

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬ÙˆØ¯Ø©
      const qualitySelect = document.getElementById('qualitySelect');
      qualitySelect.innerHTML = '';
      
      availableQualities.sort((a, b) => {
        const qualityOrder = { '4K': 4, 'FHD': 3, 'HD': 2, 'SD': 1 };
        return (qualityOrder[b.quality] || 0) - (qualityOrder[a.quality] || 0);
      }).forEach(quality => {
        const option = document.createElement('option');
        option.value = quality.url;
        option.textContent = `${quality.quality} (${quality.url.includes('.m3u8') ? 'HLS' : 'MP4'})`;
        qualitySelect.appendChild(option);
      });

      advancedControls.style.display = 'flex';
      
      // ØªØ´ØºÙŠÙ„ Ø£Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø© Ù…ØªØ§Ø­Ø©
      changeQuality();
      
      // ØªØ­Ù…ÙŠÙ„ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ ØªØ¨ÙˆÙŠØ¨ EPG
      if (currentTab === 'epg') {
        loadEPG(channelName);
      }
      
      // ØªØªØ¨Ø¹ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
      startTrackingViewingStats();
    }

    // ØªØºÙŠÙŠØ± Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø«
    function changeQuality() {
      const video = document.getElementById('player');
      const url = document.getElementById('qualitySelect').value;
      const channelName = document.getElementById('channelSelect').value;
      
      if (!url || !channelName) return;

      showLoading(true);
      video.pause();
      video.src = '';
      
      const isHLS = url.endsWith(".m3u8") || url.includes("/hls/") || url.includes("/live/");

      if (isHLS && Hls.isSupported()) {
        if (currentHls) {
          currentHls.destroy();
        }
        
        currentHls = new Hls({
          maxBufferLength: 30,
          maxMaxBufferLength: 600,
          maxBufferSize: 60 * 1000 * 1000,
          maxBufferHole: 5.0,
          lowLatencyMode: false,
          enableWorker: true
        });
        
        currentHls.loadSource(url);
        currentHls.attachMedia(video);

        currentHls.on(Hls.Events.MANIFEST_PARSED, () => {
          showLoading(false);
          video.play().catch(e => {
            showNotification("ÙŠØªØ·Ù„Ø¨ Ø§Ù„ØªØ´ØºÙŠÙ„ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.", 'warning');
          });
        });

        currentHls.on(Hls.Events.ERROR, (event, data) => {
          console.error("HLS error:", data);
          if (data.fatal) {
            switch(data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                showNotification("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©. Ø¬Ø§Ø±Ù Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...", 'warning');
                currentHls.startLoad();
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                showNotification("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·. Ø¬Ø§Ø±Ù Ø¥ØµÙ„Ø§Ø­Ù‡...", 'warning');
                currentHls.recoverMediaError();
                break;
              default:
                showNotification("Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¬Ø±Ø¨Ø© Ø¬ÙˆØ¯Ø© Ø£Ø®Ø±Ù‰.", 'error');
                currentHls.destroy();
                break;
            }
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        // Ù„Ù…ØªØµÙØ­Ø§Øª Safari
        video.src = url;
        video.addEventListener('loadedmetadata', () => {
          showLoading(false);
          video.play().catch(e => {
            showNotification("ÙŠØªØ·Ù„Ø¨ Ø§Ù„ØªØ´ØºÙŠÙ„ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.", 'warning');
          });
        });
      } else {
        // Ù„Ù„ØµÙŠØº Ø§Ù„Ø£Ø®Ø±Ù‰
        video.src = url;
        video.addEventListener('canplay', () => {
          showLoading(false);
          video.play().catch(e => {
            showNotification("ÙŠØªØ·Ù„Ø¨ Ø§Ù„ØªØ´ØºÙŠÙ„ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.", 'warning');
          });
        });
      }
      
      video.addEventListener('error', () => {
        showLoading(false);
        showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¬Ø±Ø¨Ø© Ø¬ÙˆØ¯Ø© Ø£Ø®Ø±Ù‰.", 'error');
      });
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±Ø¬Ù…Ø©
    function loadSubtitle() {
      const lang = document.getElementById('subtitleSelect').value;
      if (!lang || !currentChannel) return;
      
      // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ù…Ù† Ù…ØµØ¯Ø± Ø®Ø§Ø±Ø¬ÙŠ
      showNotification(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±Ø¬Ù…Ø© ${lang === 'ar' ? 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©'}`, 'success');
    }

    // ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØªÙŠ
    function changeAudioTrack() {
      const track = document.getElementById('audioTrackSelect').value;
      if (!currentChannel) return;
      
      // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØªÙŠ
      showNotification(`ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ ${track === 'original' ? 'Ø§Ù„Ø£ØµÙ„ÙŠ' : 'Ø§Ù„Ù…Ø¯Ø¨Ù„Ø¬'}`, 'success');
    }

    // Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
    function toggleFullscreen() {
      const video = document.getElementById('player');
      
      if (!document.fullscreenElement) {
        if (video.requestFullscreen) {
          video.requestFullscreen();
        } else if (video.webkitRequestFullscreen) { /* Safari */
          video.webkitRequestFullscreen();
        } else if (video.msRequestFullscreen) { /* IE11 */
          video.msRequestFullscreen();
        }
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) { /* Safari */
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) { /* IE11 */
          document.msExitFullscreen();
        }
      }
    }

    // Ø¨Ø¯Ø¡/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    function toggleRecording() {
      const video = document.getElementById('player');
      const recordBtn = document.getElementById('recordBtn');
      const recordingIndicator = document.getElementById('recordingIndicator');
      
      if (!currentRecorder) {
        try {
          const stream = video.captureStream();
          const chunks = [];
          
          currentRecorder = new MediaRecorder(stream);
          
          currentRecorder.ondataavailable = e => chunks.push(e.data);
          currentRecorder.onstop = () => {
            const blob = new Blob(chunks, { type: 'video/mp4' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `ØªØ³Ø¬ÙŠÙ„-${currentChannel.name}-${new Date().toLocaleString()}.mp4`;
            a.click();
            
            showNotification("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­", 'success');
          };
          
          currentRecorder.start(1000); // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
          recordingIndicator.style.display = 'block';
          recordBtn.innerHTML = '<i class="fas fa-stop"></i> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
          recordBtn.classList.remove('btn-success');
          recordBtn.classList.add('btn-danger');
          
          showNotification("Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...", 'success');
        } catch (e) {
          showNotification("Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: " + e.message, 'error');
          console.error(e);
        }
      } else {
        currentRecorder.stop();
        currentRecorder = null;
        recordingIndicator.style.display = 'none';
        recordBtn.innerHTML = '<i class="fas fa-circle"></i> ØªØ³Ø¬ÙŠÙ„';
        recordBtn.classList.remove('btn-danger');
        recordBtn.classList.add('btn-success');
      }
    }

    // ÙˆØ¶Ø¹ ØªÙˆÙÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
    function enableBatterySaver() {
      const video = document.getElementById('player');
      video.preload = 'none';
      video.playsInline = true;
      video.autoplay = false;
      
      if ('connection' in navigator) {
        if (navigator.connection.saveData) {
          document.getElementById('qualitySelect').value = document.querySelector('#qualitySelect option').value;
          changeQuality();
        }
      }
      
      showNotification("ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ ØªÙˆÙÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©", 'success');
    }

    /* Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØ¶Ù„Ø© */
    function saveFavorite() {
      const currentUrl = document.getElementById('m3uUrl').value.trim();
      if (!currentUrl) {
        showNotification("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù„Ø­ÙØ¸Ù‡ ÙÙŠ Ø§Ù„Ù…ÙØ¶Ù„Ø©", 'error');
        return;
      }
      
      if (!favorites.includes(currentUrl)) {
        favorites.push(currentUrl);
        localStorage.setItem('favorites', JSON.stringify(favorites));
        updateFavoritesMenu();
        showNotification("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©", 'success');
      } else {
        showNotification("Ø§Ù„Ø±Ø§Ø¨Ø· Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù…ÙØ¶Ù„Ø©", 'warning');
      }
    }
    
    function removeFavorite(url) {
      favorites = favorites.filter(fav => fav !== url);
      localStorage.setItem('favorites', JSON.stringify(favorites));
      updateFavoritesMenu();
      showNotification("ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©", 'success');
    }
    
    function loadFavorite(url) {
      document.getElementById('m3uUrl').value = url;
      loadM3U();
      toggleFavoritesMenu();
    }
    
    function toggleFavoritesMenu() {
      const menu = document.getElementById('favoritesMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }
    
    function updateFavoritesMenu() {
      const menu = document.getElementById('favoritesMenu');
      menu.innerHTML = '';
      
      if (favorites.length === 0) {
        menu.innerHTML = '<div class="favorite-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙØ¶Ù„Ø§Øª</div>';
        return;
      }
      
      favorites.forEach(url => {
        const item = document.createElement('div');
        item.className = 'favorite-item';
        item.innerHTML = `
          <span>${url.substring(0, 30)}...</span>
          <button class="btn btn-sm btn-primary" onclick="loadFavorite('${url}')"><i class="fas fa-play"></i></button>
          <button class="btn btn-sm btn-danger" onclick="removeFavorite('${url}')"><i class="fas fa-trash"></i></button>
        `;
        menu.appendChild(item);
      });
    }

    /* Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
    function setupRatingStars() {
      document.querySelectorAll('.rating-star').forEach(star => {
        star.addEventListener('click', function() {
          const rating = parseInt(this.dataset.rating);
          rateChannel(rating);
        });
      });
    }
    
    function updateRatingStars(channelName) {
      const rating = channelRatings[channelName] || 0;
      
      document.querySelectorAll('.rating-star').forEach(star => {
        const starRating = parseInt(star.dataset.rating);
        star.classList.toggle('active', starRating <= rating);
      });
    }
    
    function rateChannel(rating) {
      if (!currentChannel) return;
      
      const channelName = currentChannel.tvgName || currentChannel.name;
      channelRatings[channelName] = rating;
      localStorage.setItem('channelRatings', JSON.stringify(channelRatings));
      
      updateRatingStars(channelName);
      showNotification(`ØªÙ… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù‚Ù†Ø§Ø© Ø¨Ù€ ${rating} Ù†Ø¬ÙˆÙ…`, 'success');
    }

    /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø£Ø¨ÙˆÙŠØ© */
    function lockParentalControl() {
      const newPassword = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø£Ø¨ÙˆÙŠØ©:");
      if (newPassword) {
        parentalPassword = newPassword;
        parentalControlEnabled = true;
        localStorage.setItem('parentalPassword', parentalPassword);
        localStorage.setItem('parentalControlEnabled', 'true');
        showNotification("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚ÙÙ„ Ø§Ù„Ø£Ø¨ÙˆÙŠ Ø¨Ù†Ø¬Ø§Ø­", 'success');
      }
    }
    
    function checkParentalPassword() {
      const input = document.getElementById('parentalPassword').value;
      if (input === parentalPassword) {
        document.getElementById('parentalControl').style.display = 'none';
        document.getElementById('parentalPassword').value = '';
        
        // Ù…ØªØ§Ø¨Ø¹Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù…Ø­Ù…ÙŠØ©
        if (currentChannel) {
          const availableQualities = channelQuality[currentChannel.name];
          if (availableQualities && availableQualities.length > 0) {
            document.getElementById('qualitySelect').value = availableQualities[0].url;
            changeQuality();
          }
        }
      } else {
        showNotification("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©", 'error');
      }
    }
    
    function disableParentalControl() {
      parentalControlEnabled = false;
      localStorage.setItem('parentalControlEnabled', 'false');
      showNotification("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙÙ„ Ø§Ù„Ø£Ø¨ÙˆÙŠ", 'success');
    }

    /* Ù†Ø¸Ø§Ù… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© */
    function startTrackingViewingStats() {
      if (!currentChannel) return;
      
      const channelName = currentChannel.tvgName || currentChannel.name;
      const stats = {
        channel: channelName,
        startTime: new Date(),
        duration: 0,
        quality: document.getElementById('qualitySelect').value
      };
      
      const interval = setInterval(() => {
        stats.duration++;
        viewingStats.push({...stats, timestamp: new Date()});
        
        // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ ÙÙ‚Ø· Ø¨Ø¢Ø®Ø± 100 Ø³Ø¬Ù„
        if (viewingStats.length > 100) {
          viewingStats.shift();
        }
        
        localStorage.setItem('viewingStats', JSON.stringify(viewingStats));
      }, 1000);
      
      return () => clearInterval(interval);
    }

    /* Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø© */
    function initMultiview() {
      for (let i = 1; i <= 4; i++) {
        multiviewPlayers[i] = {
          hls: null,
          channel: null
        };
      }
      
      updateMultiviewChannelSelects();
    }
    
    function updateMultiviewChannelSelects() {
      document.querySelectorAll('.multiview-channel-select').forEach(select => {
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù‚Ù†Ø§Ø©</option>';
        
        Object.keys(channelQuality).forEach(channel => {
          const option = document.createElement('option');
          option.value = channel;
          option.textContent = channel;
          select.appendChild(option);
        });
      });
    }
    
    function changeMultiviewChannel(screenNum, channelName) {
      if (!channelName) return;
      
      const screen = document.querySelector(`.multiview-screen[data-channel="${screenNum}"] video`);
      const availableQualities = channelQuality[channelName];
      
      if (!availableQualities || availableQualities.length === 0) {
        showNotification("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ù†Ø§Ø©", 'error');
        return;
      }
      
      // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ
      if (multiviewPlayers[screenNum].hls) {
        multiviewPlayers[screenNum].hls.destroy();
      }
      
      const url = availableQualities[0].url;
      const isHLS = url.endsWith(".m3u8") || url.includes("/hls/") || url.includes("/live/");

      if (isHLS && Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(screen);
        
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          screen.play().catch(e => console.error("Autoplay prevented:", e));
        });
        
        multiviewPlayers[screenNum] = { hls, channel: channelName };
      } else {
        screen.src = url;
        screen.addEventListener('canplay', () => {
          screen.play().catch(e => console.error("Autoplay prevented:", e));
        });
        
        multiviewPlayers[screenNum] = { hls: null, channel: channelName };
      }
    }
    
    function focusMultiviewScreen(screenNum) {
      const channelName = multiviewPlayers[screenNum].channel;
      if (!channelName) return;
      
      document.getElementById('channelSelect').value = channelName;
      playChannel();
      switchTab('player');
    }
    
    function startAllMultiview() {
      document.querySelectorAll('.multiview-channel-select').forEach((select, i) => {
        if (select.value) {
          changeMultiviewChannel(i + 1, select.value);
        }
      });
    }
    
    function stopAllMultiview() {
      for (let i = 1; i <= 4; i++) {
        if (multiviewPlayers[i].hls) {
          multiviewPlayers[i].hls.destroy();
          multiviewPlayers[i].hls = null;
        }
        
        const screen = document.querySelector(`.multiview-screen[data-channel="${i}"] video`);
        screen.src = '';
        screen.load();
        
        multiviewPlayers[i].channel = null;
      }
    }

    /* Ù†Ø¸Ø§Ù… Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ EPG */
    function loadEPG(channelName) {
      // Ù‡Ø°Ù‡ ÙˆØ¸ÙŠÙØ© ÙˆÙ‡Ù…ÙŠØ© - ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø³ØªÙ‚ÙˆÙ… Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© EPG
      const epgContainer = document.getElementById('epgContainer');
      epgContainer.innerHTML = '';
      
      // Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ© Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø¹Ø±Ø¶
      const dummyEPG = [
        {
          title: "Ù…Ø³Ù„Ø³Ù„ Ø¯Ø±Ø§Ù…ÙŠ",
          description: "Ø­Ù„Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ù…Ø³Ù„Ø³Ù„ Ø§Ù„Ø¯Ø±Ø§Ù…ÙŠ Ø§Ù„Ø´Ù‡ÙŠØ±",
          start: "20:00",
          end: "21:00",
          live: true
        },
        {
          title: "Ù†Ø´Ø±Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±",
          description: "Ø¢Ø®Ø± Ø§Ù„Ù…Ø³ØªØ¬Ø¯Ø§Øª ÙˆØ§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¹Ø§Ø¬Ù„Ø©",
          start: "21:00",
          end: "21:30",
          live: false
        },
        {
          title: "Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ±ÙÙŠÙ‡ÙŠ",
          description: "Ø¶ÙŠÙ Ø§Ù„Ø­Ù„Ù‚Ø©: Ø§Ù„ÙÙ†Ø§Ù† Ø§Ù„Ù…Ø´Ù‡ÙˆØ±",
          start: "21:30",
          end: "22:30",
          live: false
        }
      ];
      
      dummyEPG.forEach(program => {
        const programEl = document.createElement('div');
        programEl.className = `epg-program ${program.live ? 'live' : ''}`;
        programEl.innerHTML = `
          <div class="epg-time">${program.start} - ${program.end}</div>
          <div class="epg-title">${program.title}</div>
          <div class="epg-description">${program.description}</div>
        `;
        epgContainer.appendChild(programEl);
      });
      
      document.getElementById('epgSection').style.display = 'block';
    }
    
    function loadCurrentEPG() {
      if (!currentChannel) {
        showNotification("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†Ø§Ø© Ù…Ø­Ø¯Ø¯Ø©", 'error');
        return;
      }
      
      loadEPG(currentChannel.name);
      showNotification("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬", 'success');
    }
    
    function addCurrentToCalendar() {
      // Ù‡Ø°Ù‡ ÙˆØ¸ÙŠÙØ© ÙˆÙ‡Ù…ÙŠØ© - ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø³ØªØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
      showNotification("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…", 'success');
    }

    /* Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ */
    document.addEventListener('keydown', (e) => {
      const video = document.getElementById('player');
      if (!video) return;
      
      switch(e.key) {
        case ' ':
          if (video.paused) video.play();
          else video.pause();
          e.preventDefault();
          break;
        case 'ArrowRight':
          video.currentTime += 5;
          break;
        case 'ArrowLeft':
          video.currentTime -= 5;
          break;
        case 'ArrowUp':
          video.volume = Math.min(video.volume + 0.1, 1);
          break;
        case 'ArrowDown':
          video.volume = Math.max(video.volume - 0.1, 0);
          break;
        case 'f':
          toggleFullscreen();
          break;
        case 'm':
          video.muted = !video.muted;
          break;
        case 'r':
          toggleRecording();
          break;
        case '1':
          switchTab('player');
          break;
        case '2':
          switchTab('multiview');
          break;
        case '3':
          switchTab('epg');
          break;
      }
    });
  </script>
</body>
</html>